<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gold Visibility Color Creator</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <!-- Bootstrap 3 -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
            integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
            crossorigin="anonymous"></script>

    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"
          integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

    <!-- MiniColors -->
    <script src="jquery.minicolors.min.js"></script>
    <link rel="stylesheet" href="jquery.minicolors.css">

    <link id="favicon" rel="icon" type="image/x-icon"/>

    <style>
        [hidden] {
            display: none !important;
        }

        label.btn-link {
            padding-left: 0;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="col-sm-6 col-sm-offset-3">
        <h2>Gold Visibility Color Creator</h2>
        <br/>
        <div id="errors"></div>
        <input type="text" class="form-control" id="color-input" value="rgba(192, 0, 255, 1)">
        <br/>
        <label class="btn btn-link">
            Upload image <span class="badge">optional</span> <input id="file-input" type="file"
                                                                    accept=".png,.tiff,.tga,.dds" hidden>
        </label>
        <span id="file-name"></span>
        <button id="remove-file" class="btn btn-xs btn-default" style="display: none">
            <span class="fa fa-close"></span>
        </button>
        <p class="help-block">Maximum image size: 200 KB, up to 512x512 pixels. PNG is recommended.</p>
        <div id="fill-method-inputs" style="display: none">
            <label class="radio control-label">Image fill method</label>
            <label class="radio-inline"><input type="radio" name="fillmethod" value="none" checked>
                Do not fill
            </label>
            <label class="radio-inline">
                <input type="radio" name="fillmethod" value="solid">Fill with solid color
            </label>
            <label class="radio-inline"><input type="radio" name="fillmethod" value="luminize">
                Luminize
            </label>
        </div>
        <br/>
        <button id="button" class="btn btn-default btn-block"
                data-create-text="Create"
                data-sending-text="<i class='fa fa-refresh fa-spin'></i> Creating job..."
                data-waiting-text="<i class='fa fa-refresh fa-spin'></i> Waiting in queue..."
                data-creating-text="<i class='fa fa-refresh fa-spin'></i> Creating file..."
                data-downloading-text="<i class='fa fa-refresh fa-spin'></i> Downloading...">
        </button>
        <div id="download-link" style="display: none">
            <br/>
            <a href="#">Download failed? Try again.</a>
        </div>
        <br/>
        <h4>Usage</h4>
        <ol>
            <li>Download and install the Gold Visibility Mod from <a href="https://wgmods.net/1233" target="_blank">WG
                Mods</a> or the
                <a href="http://forum.worldoftanks.eu/index.php?/topic/669824-1010-gold-ammo-visibility-mod-204/"
                   target="_blank">European forum</a>. Any color will work.
            </li>
            <li>Select a color in the color picker above.</li>
            <li>Optional: You can also upload an image which will replace the smoke effects.
                The effect will have the color selected above.
                For the best results the background of the image should be transparent.
                The recommended image format is PNG as it allows for transparency.
                Check out <a href="https://www.flaticon.com/" target="_blank">Flaticon.com</a> for a huge selection of
                free shapes and icons.
            </li>
            <li>Click on "Create" and wait for the process to finish. <strong>This can take up to a minute!</strong>
            </li>
            <li>Save the generated .wotmod file to your computer.</li>
            <li>Copy the file into your WoT /mods/&lt;current version&gt; folder.</li>
        </ol>
        <h4>Troubleshooting</h4>
        <ul>
            <li>Make sure to use a modern browser like Chrome or Firefox.</li>
            <li>Click the link below the "Create" button should the automatic download not work.</li>
        </ul>
    </div>
</div>


<script>
    const createButton = $('#button');
    const downloadLink = $('#download-link');
    const errors = $('#errors');
    const fileInput = $('#file-input');
    const fileName = $('#file-name');
    const removeFile = $('#remove-file');
    const fillMethodInputs = $('#fill-method-inputs');
    const colorInput = $('#color-input');
    colorInput.minicolors({
        format: 'rgb',
        opacity: true,
        theme: 'bootstrap',
        swatches: [
            '#0056FF',
            '#0095FF',
            '#00FFFF',
            '#00F000',
            '#6BFF00',
            '#C000FF',
            '#FF00F4',
            '#FF0000',
            '#FF9000',
            '#FFF700'
        ],
        change: renderFavicon,
        changeDelay: 200
    });

    const favicon = $('#favicon');
    const canvas = document.createElement('canvas');
    canvas.width = 16;
    canvas.height = 16;

    function renderFavicon(value) {
        const ctx = canvas.getContext("2d");
        ctx.beginPath();
        ctx.rect(0, 0, 16, 16);
        ctx.fillStyle = value;
        ctx.fill();
        favicon.attr('href', canvas.toDataURL());
    }

    let msDownloadHandler = function () {
    };
    downloadLink.find('a').on('click', function () {
        msDownloadHandler()
    });

    function saveBlob(blob, fileName) {
        if (window.navigator.msSaveOrOpenBlob) {
            window.navigator.msSaveOrOpenBlob(blob, fileName);
            msDownloadHandler = function () {
                saveBlob(blob, fileName)
            };
        } else {
            const url = window.URL.createObjectURL(blob);
            const a = downloadLink.find('a').get(0);
            a.href = url;
            a.download = fileName;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        downloadLink.show();
    }

    function pushError(errorMsg) {
        errors.append(`
            <div class="alert alert-danger alert-dismissible" role="alert">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span class="fa fa-close"></span>
                </button>
                <strong>Error!</strong> ${errorMsg}
            </div>
        `);
    }

    function makeStatus(name, inputDisabled) {
        return function (hash) {
            if (hash !== undefined) {
                location.hash = hash;
            }
            if (this.currentStatus === name) return;
            createButton.button(name);
            createButton.prop('disabled', inputDisabled);
            colorInput.prop('disabled', inputDisabled || ($('input:checked', fillMethodInputs).val() === 'none' && !!fileInput.prop('files')[0]));
            fileInput.prop('disabled', inputDisabled);
            $('input', fillMethodInputs).prop('disabled', inputDisabled);
            removeFile.prop('disabled', inputDisabled);
            this.currentStatus = name;
        };
    }

    const status = {
        sending: makeStatus('sending', true),
        waiting: makeStatus('waiting', true),
        creating: makeStatus('creating', true),
        downloading: makeStatus('downloading', true),
        reset: makeStatus('create', false, '')
    };

    function handleError(err) {
        status.reset('');
        pushError(err || 'Something went wrong.');
    }

    const SERVICE_URL = 'https://sleepy-hamlet-28159.herokuapp.com';

    function createJob() {
        status.sending();
        downloadLink.hide();

        const makeBody = file => {
            const formData = new FormData();
            formData.append('file', file);
            return formData;
        };

        const options = { method: "POST" };
        const icon = fileInput.prop('files')[0];
        if (icon) options.body = makeBody(icon);

        const params = {};
        params.color = $('input:checked', fillMethodInputs).val() !== 'none' || !icon ? colorInput.val() : undefined;
        if ($('input:checked', fillMethodInputs).val() === 'luminize' && icon) params.luminize = true;

        const query = Object.keys(params).filter(k => {
            return params[k] !== undefined && params[k] !== '';
        }).map(k => {
            return encodeURIComponent(k) + '=' + encodeURIComponent(params[k]);
        }).join('&');

        fetch(SERVICE_URL + '/create?' + query, options).then(response => {
            return response.json();
        }).then(obj => {
            if (obj.status === 'error') throw obj.errorMsg;
            location.hash = obj.jobId;
            pollStatus(obj.jobId);
        }).catch(handleError);
    }

    function pollStatus(jobId) {
        fetch(SERVICE_URL + '/status/' + jobId).then(response => {
            return response.json();
        }).then(obj => {
            if (obj.status === 'error') throw obj.errorMsg;

            if (obj.status === 'finished') return getResult(jobId);

            if (obj.status === 'created') status.waiting();
            if (obj.status === 'started') status.creating();
            setTimeout(function () {
                pollStatus(jobId)
            }, 1000);
        }).catch(handleError);
    }

    function getResult(jobId) {
        fetch(SERVICE_URL + '/download/' + jobId).then(response => {
            status.downloading();
            return response.blob();
        }).then(blob => {
            saveBlob(blob, 'goldvisibility.color.wotmod');
            status.reset('');
        }).catch(handleError);
    }

    status.reset();
    renderFavicon(colorInput.val());
    createButton.on('click', createJob);

    fileInput.on('change', function () {
        colorInput.prop('disabled', $('input:checked', fillMethodInputs).val() === 'none');
        fileName.text(fileInput.val().split(/(\\|\/)/g).pop());
        removeFile.show();
        fillMethodInputs.show();
    });

    removeFile.on('click', function () {
        colorInput.prop('disabled', false);
        $('input', fillMethodInputs).first().prop('checked', true);
        fillMethodInputs.hide();
        removeFile.hide();
        fileInput.val('');
        fileName.text('');
    });

    fillMethodInputs.on('change', function () {
        colorInput.prop('disabled', $('input:checked', fillMethodInputs).val() === 'none');
    });

    if (location.hash !== undefined && location.hash !== '') {
        status.waiting();
        pollStatus(location.hash.substring(1));
    }
</script>

<img src="http://bit.ly/2FSCuOg">
</body>
</html>