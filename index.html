<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gold Visibility Color Creator</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <!-- Bootstrap 3 -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

    <!-- MiniColors -->
    <script src="jquery.minicolors.min.js"></script>
    <link rel="stylesheet" href="jquery.minicolors.css">
</head>
<body>

<div class="container">
    <div class="col-sm-6 col-sm-offset-3">
        <h2>Gold Visibility Color Creator</h2>
        <br/>
        <div id="errors"></div>
        <input type="text" class="form-control" id="color-input" value="rgb(255, 0, 0, 1)">
        <br/>
        <button id="button" class="btn btn-default btn-block"
                data-create-text="Create"
                data-creating-text="<i class='fa fa-refresh fa-spin'></i> Creating..."
                data-downloading-text="<i class='fa fa-refresh fa-spin'></i> Downloading..."
                data-save-text="Save">
        </button>
        <br/>
        <h4>How does this work?</h4>
        <ol>
            <li>Download and install the regular Gold Visibility Mod from <a href="https://wgmods.net/1233">wgmods.net/1233</a>.
                The installed color does not matter, we will be replacing that with a custom one later.</li>
            <li>Select a color in the color picker above. Click on "Create" and wait for the process to finish. <strong>This can take up to a minute!</strong></li>
            <li>Click on "Save" to save the .wotmod file to your computer.</li>
            <li>Copy the file into your WoT <strong>/mods/&lt;current version&gt;</strong> folder.</li>
        </ol>
    </div>
</div>


<script>
    // https://gist.github.com/philipstanislaus/c7de1f43b52531001412
    const saveBlob = (function () {
        const a = document.createElement("a");
        document.body.appendChild(a);
        a.style = "display: none";
        return function (blob, fileName) {
            const url = window.URL.createObjectURL(blob);
            a.href = url;
            a.download = fileName;
            a.click();
            window.URL.revokeObjectURL(url);
        };
    }());

    const colorInput = $('#color-input');
    colorInput.minicolors({
        format: 'rgb',
        opacity: true,
        theme: 'bootstrap',
        swatches: [
            '#0056FF',
            '#0095FF',
            '#00FFFF',
            '#00F000',
            '#6BFF00',
            '#C000FF',
            '#FF00F4',
            '#FF0000',
            '#FF9000',
            '#FFF700'
        ]
    });

    const button = $('#button');
    const errors = $('#errors');

    function pushError(errorMsg) {
        errors.append(`
            <div class="alert alert-danger alert-dismissible" role="alert">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <strong>Error!</strong> ${errorMsg}
            </div>
        `);
    }

    function createDownload() {
        button.button('creating');
        button.prop('disabled', true);
        const colorParam = encodeURIComponent(colorInput.val());
        fetch('https://sleepy-hamlet-28159.herokuapp.com/color/' + colorParam).then(response => {
            button.button('downloading');
            return response.blob();
        }).then(blob => {
            button.button('save');
            button.one('click', saveDownload(blob));
        }).catch(err => {
            button.button('create');
            pushError(err || 'Somethign went wrong.');
        }).finally(() => {
            button.prop('disabled', false);
        });
    }

    function saveDownload(blob) {
        return function () {
            saveBlob(blob, 'goldvisibility.color.wotmod');
            button.button('create');
            button.one('click', createDownload);
        };
    }

    button.one('click', createDownload);
    button.button('create')
</script>

</body>
</html>