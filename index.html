<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gold Visibility Color Creator</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <!-- Bootstrap 3 -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
            integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
            crossorigin="anonymous"></script>

    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"
          integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

    <!-- MiniColors -->
    <script src="jquery.minicolors.min.js"></script>
    <link rel="stylesheet" href="jquery.minicolors.css">

    <link id="favicon" rel="icon" type="image/x-icon"/>

    <style>
        [hidden] {
            display: none !important;
        }

        label.btn-link {
            padding-left: 0;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="col-sm-6 col-sm-offset-3">
        <h2>Gold Visibility Color Creator</h2>
        <br/>
        <div id="errors"></div>
        <input type="text" class="form-control" id="color-input" value="rgba(192, 0, 255, 1)">
        <br/>
        <label class="btn btn-link">
            Upload shape <span class="badge">optional</span> <input id="file-input" type="file" accept=".png,.tiff,.tga,.dds" hidden>
        </label>
        <span id="file-name"></span>
        <button id="remove-file" class="btn btn-xs btn-default" style="display: none">
            <span class="fa fa-close"></span>
        </button>
        <p class="help-block">Maximum image size: 200 KB, up to 512x512 pixels. PNG is recommended.</p>
        <div class="checkbox" id="keep-color" style="display: none">
            <label>
                <input type="checkbox"> <strong>Do not fill the shape</strong> - keep the original color of the image
            </label>
        </div>
        <br/>
        <button id="button" class="btn btn-default btn-block"
                data-create-text="Create"
                data-sending-text="<i class='fa fa-refresh fa-spin'></i> Creating job..."
                data-waiting-text="<i class='fa fa-refresh fa-spin'></i> Waiting in queue..."
                data-creating-text="<i class='fa fa-refresh fa-spin'></i> Creating file..."
                data-downloading-text="<i class='fa fa-refresh fa-spin'></i> Downloading...">
        </button>
        <br/>
        <h4>How does this work?</h4>
        <ol>
            <li>Download and install the Gold Visibility Mod from <a href="https://wgmods.net/1233" target="_blank">WG
                Mods</a> or the
                <a href="http://forum.worldoftanks.eu/index.php?/topic/669824-1010-gold-ammo-visibility-mod-204/"
                   target="_blank">European forum</a>. Any color will work.
            </li>
            <li>Select a color in the color picker above.</li>
            <li><em>Optional:</em> You can also upload a shape which will replace the smoke effects.
                The effect will have the color selected above. The recommended image format is PNG.
                <strong>The background of the image must be transparent!</strong>
                Check out <a href="https://www.flaticon.com/" target="_blank">Flaticon.com</a> for a huge selection of
                free shapes and icons.
            </li>
            <li>Click on "Create" and wait for the process to finish. <strong>This can take up to 100 seconds!</strong>
            </li>
            <li>Save the generated .wotmod file to your computer.</li>
            <li>Copy the file into your WoT <strong>/mods/&lt;current version&gt;</strong> folder.</li>
        </ol>
    </div>
</div>


<script>
    const createButton = $('#button');
    const errors = $('#errors');
    const fileInput = $('#file-input');
    const fileName = $('#file-name');
    const removeFile = $('#remove-file');
    const keepColor = $('#keep-color');
    const colorInput = $('#color-input');
    colorInput.minicolors({
        format: 'rgb',
        opacity: true,
        theme: 'bootstrap',
        swatches: [
            '#0056FF',
            '#0095FF',
            '#00FFFF',
            '#00F000',
            '#6BFF00',
            '#C000FF',
            '#FF00F4',
            '#FF0000',
            '#FF9000',
            '#FFF700'
        ],
        change: renderFavicon,
        changeDelay: 200
    });

    const favicon = $('#favicon');
    const canvas = document.createElement('canvas');
    canvas.width = 16;
    canvas.height = 16;

    function renderFavicon(value) {
        const ctx = canvas.getContext("2d");
        ctx.beginPath();
        ctx.rect(0, 0, 16, 16);
        ctx.fillStyle = value;
        ctx.fill();
        favicon.attr('href', canvas.toDataURL());
    }

    // https://gist.github.com/philipstanislaus/c7de1f43b52531001412
    const saveBlob = (function () {
        const a = document.createElement("a");
        document.body.appendChild(a);
        a.style = "display: none";
        return function (blob, fileName) {
            const url = window.URL.createObjectURL(blob);
            a.href = url;
            a.download = fileName;
            a.click();
            window.URL.revokeObjectURL(url);
        };
    }());

    function pushError(errorMsg) {
        errors.append(`
            <div class="alert alert-danger alert-dismissible" role="alert">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span class="fa fa-close"></span>
                </button>
                <strong>Error!</strong> ${errorMsg}
            </div>
        `);
    }

    function makeStatus(name, inputDisabled) {
        return function () {
            if (this.currentStatus === name) return;
            createButton.button(name);
            createButton.prop('disabled', inputDisabled);
            colorInput.prop('disabled', inputDisabled || keepColor.find('input').prop('checked'));
            fileInput.prop('disabled', inputDisabled);
            keepColor.find('input').prop('disabled', inputDisabled);
            removeFile.prop('disabled', inputDisabled);
            this.currentStatus = name;
        };
    }

    const status = {
        sending: makeStatus('sending', true),
        waiting: makeStatus('waiting', true),
        creating: makeStatus('creating', true),
        downloading: makeStatus('downloading', true),
        reset: makeStatus('create', false)
    };

    function handleError(err) {
        status.reset();
        pushError(err || 'Something went wrong.');
    }

    const SERVICE_URL = 'https://sleepy-hamlet-28159.herokuapp.com';

    function createJob() {
        status.sending();

        const makeBody = file => {
            const formData = new FormData();
            formData.append('file', file);
            return formData;
        };

        const options = {};
        const icon = fileInput.prop('files')[0];
        if (icon) {
            options.method = 'POST';
            options.body = makeBody(icon);
        }

        const params = {
            color: !keepColor.find('input').prop('checked') ? colorInput.val() : undefined
        };
        const query = Object.keys(params).filter(k => {
            return params[k] !== undefined && params[k] !== '';
        }).map(k => {
            return encodeURIComponent(k) + '=' + encodeURIComponent(params[k]);
        }).join('&');

        fetch(SERVICE_URL + '/create?' + query, options).then(response => {
            return response.json();
        }).then(obj => {
            if (obj.status === 'error') throw obj.errorMsg;
            location.hash = obj.jobId;
            pollStatus(obj.jobId);
        }).catch(handleError);
    }

    function pollStatus(jobId) {
        fetch(SERVICE_URL + '/status/' + jobId).then(response => {
            return response.json();
        }).then(obj => {
            if (obj.status === 'error') throw obj.errorMsg;

            if (obj.status === 'finished') return getResult(jobId);

            if (obj.status === 'created') status.waiting();
            if (obj.status === 'started') status.creating();
            setTimeout(() => pollStatus(jobId), 1000);
        }).catch(handleError);
    }

    function getResult(jobId) {
        fetch(SERVICE_URL + '/download/' + jobId).then(response => {
            status.downloading();
            return response.blob();
        }).then(blob => {
            saveBlob(blob, 'goldvisibility.color.wotmod');
            status.reset();
        }).catch(handleError);
    }

    status.reset();
    renderFavicon(colorInput.val());
    createButton.on('click', createJob);

    fileInput.on('change', () => {
        keepColor.find('input').prop('checked', true);
        colorInput.prop('disabled', true);
        fileName.text(fileInput.val().split(/(\\|\/)/g).pop());
        removeFile.show();
        keepColor.show();
    });

    removeFile.on('click', () => {
        keepColor.find('input').prop('checked', false);
        colorInput.prop('disabled', false);
        keepColor.hide();
        removeFile.hide();
        fileInput.val('');
        fileName.text('');
    });

    keepColor.find('input').on('change', function () {
        colorInput.prop('disabled', this.checked);
    });

    if (location.hash !== undefined && location.hash !== '') {
        status.sending();
        pollStatus(location.hash.substring(1));
    }
</script>

</body>
</html>